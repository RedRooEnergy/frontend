name: Buyer Evidence Pack CI

on:
  pull_request:
    paths:
      - "docs/extensions/EXT-BUYER-01/**"
      - "frontend/scripts/**"
      - "frontend/tests/**"
      - "frontend/schemas/**"

jobs:
  buyer-evidence:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run PDF stamp test
        id: pdf_stamp
        continue-on-error: true
        working-directory: frontend
        run: npm run test:pdf-stamp

      - name: Run evidence pack test
        id: evidence_pack
        continue-on-error: true
        working-directory: frontend
        run: npm run test:evidence-pack

      - name: Upload evidence pack artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buyer-evidence-pack
          path: |
            frontend/.tmp/evidence-pack/artifacts/evidence/EXT-BUYER-01/**/*
          if-no-files-found: warn

      - name: Fail on test failures
        if: ${{ steps.pdf_stamp.outcome == 'failure' || steps.evidence_pack.outcome == 'failure' }}
        run: exit 1
