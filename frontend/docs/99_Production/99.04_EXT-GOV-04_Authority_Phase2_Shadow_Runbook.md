# EXT-GOV-04 Phase 2 Runbook (Authority Shadow Enforcement)

## Scope
Phase 2 adds deterministic shadow authorization evaluation and case scaffolding without enforcement.

Included:
- `governance_authority_shadow_decisions`
- `governance_authority_shadow_override_cases`
- `governance_authority_shadow_override_case_events`
- Shadow metrics snapshot route and CLI
- Authority export `v2` with optional shadow artifacts

Excluded:
- No request blocking
- No runtime mutation based on shadow outcomes
- No Identity/Compliance enforcement

## Feature Flags (default OFF)
- `ENABLE_GOV04_AUTHORITY_SHADOW`
- `ENABLE_GOV04_AUTHORITY_SHADOW_CASE_SCAFFOLD`
- `ENABLE_GOV04_AUTHORITY_SHADOW_METRICS`
- `ENABLE_GOV04_AUTHORITY_SHADOW_METRICS_ROUTE`

## Deterministic Requirements
- `shadowEvaluatorVersion` fixed to `gov04-shadow-evaluator.v1`
- Shadow decision IDs and idempotency keys are hash-derived only
- Case IDs are derived from deterministic `caseKeyHashSha256`
- Conflict precedence is fixed and deterministic:
  1. `NO_ACTIVE_POLICY`
  2. `MULTIPLE_ACTIVE_POLICIES`
  3. `POLICY_VERSION_UNRESOLVED`
  4. `POLICY_RULE_AMBIGUOUS`
  5. `DELEGATION_SCOPE_CONFLICT`
  6. `APPROVAL_SCOPE_CONFLICT`

## Observe/Shadow Failure Behavior
- Fail-open always
- Logging continues on failure
- No inline retries
- No request/response behavior changes

## Signed Internal Metrics Route
Route:
- `POST /api/internal/governance/authority/shadow/metrics`

Security:
- HMAC SHA-256 signature required
- Â±300s timestamp tolerance
- Route disabled unless all shadow metrics flags are enabled

## Export Compatibility
- `schemaVersion=v2` includes shadow artifacts (`gov04-authority-export.v2`)
- `schemaVersion=v1` or `includeShadowArtifacts=false` returns backward-compatible `v1` shape

## Operational Checks
1. Keep all Phase 2 flags OFF in production baseline.
2. Enable shadow only in sandbox.
3. Confirm route behavior remains unchanged when shadow yields `WOULD_BLOCK`.
4. Validate case dedupe: repeated identical shadow blocks map to one case key.
5. Validate export determinism by comparing repeated exports over identical windows.

## Rollback
Immediate rollback:
- Set all Phase 2 flags to `false`

Impact:
- Stops shadow writes and shadow metrics route
- Existing append-only records remain replayable
- No destructive migration required
