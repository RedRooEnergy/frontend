# EXT-GOV-04 Phase 3A Runbook (Authority Hard Enforcement, Sandbox Cohort)

## Scope
Phase 3A enables cohort-gated hard enforcement for a single authority branch in sandbox:
- Resource/action: `catalog.product|fee_ledger.emit.product_approved`
- Route branch: `POST /api/internal/fee-engine` on `triggerEvent=PRODUCT_APPROVED`
- Cohort: allowlisted tenant + role + resource/action + policy version

Out of scope:
- No payments route enforcement
- No freight route enforcement
- No schema rollback

## Preconditions
1. Phase 1 observe and Phase 2 shadow are already enabled in sandbox.
2. Policy version hash is finalized and present in allowlist.
3. Shadow metrics route secret is configured:
   - `GOV04_AUTHORITY_SHADOW_METRICS_JOB_SECRET`

## Feature Flags (default OFF)
- `ENABLE_GOV04_AUTHORITY_ENFORCEMENT`
- `GOV04_AUTH_ENFORCEMENT_KILL_SWITCH`
- `GOV04_AUTH_ENFORCEMENT_STRICT_MODE`
- `GOV04_AUTH_ENFORCE_TENANT_ALLOWLIST`
- `GOV04_AUTH_ENFORCE_ROLE_ALLOWLIST`
- `GOV04_AUTH_ENFORCE_RESOURCE_ACTION_ALLOWLIST`
- `GOV04_AUTH_ENFORCE_POLICY_VERSION_ALLOWLIST`

## Sandbox Activation Profile (initial)
Use the following initial values:

```env
ENABLE_GOV04_AUTHORITY_ENFORCEMENT=true
GOV04_AUTH_ENFORCEMENT_KILL_SWITCH=false
GOV04_AUTH_ENFORCEMENT_STRICT_MODE=false

GOV04_AUTH_ENFORCE_TENANT_ALLOWLIST=<sandbox-tenant-id>
GOV04_AUTH_ENFORCE_ROLE_ALLOWLIST=admin
GOV04_AUTH_ENFORCE_RESOURCE_ACTION_ALLOWLIST=catalog.product|fee_ledger.emit.product_approved
GOV04_AUTH_ENFORCE_POLICY_VERSION_ALLOWLIST=<exact-policy-version-hash>
```

## Deterministic Invariants
For each enforced decision:
1. Shadow decision is persisted first.
2. Enforcement decision is persisted second.
3. Route mutation happens only after persistence.
4. Dual-write proof is evaluated:
   - `shadowDecisionHashSha256 == recomputedShadowHash == enforcementDecisionHash`
5. Divergence is persisted in `governance_authority_enforcement_decisions`:
   - `shadowVsEnforcementDivergence=true`

## Rollback Triggers
Evaluate over rolling 15-minute windows:
- `deterministicMismatchTotal > 0` -> `PAGE` (immediate rollback)
- `shadowVsEnforcementDivergenceRate > 0.005` -> `PAGE` (immediate rollback)
- `policyVersionUnresolvedRate > 0.01` -> `PAGE`
- `conflictRate > 0.03` -> `PAGE`
- `caseOpenRate > 0.05` -> `PAGE`

Rollback action:
```env
GOV04_AUTH_ENFORCEMENT_KILL_SWITCH=true
```

## Guard Evaluation Commands
Local snapshot + guard:
```bash
cd frontend
npx tsx scripts/governance/authority-enforcement-guard.ts \
  --mode local \
  --source cli_local \
  --from 2026-02-13T11:45:00.000Z \
  --to 2026-02-13T12:00:00.000Z \
  --tenantId <sandbox-tenant-id> \
  --policyId gov04.authority.catalog.product_approval.enforce.v1
```

Signed HTTP snapshot + guard:
```bash
cd frontend
npx tsx scripts/governance/authority-enforcement-guard.ts \
  --mode http \
  --url https://<host>/api/internal/governance/authority/shadow/metrics \
  --secret "$GOV04_AUTHORITY_SHADOW_METRICS_JOB_SECRET" \
  --source cli_http \
  --tenantId <sandbox-tenant-id> \
  --policyId gov04.authority.catalog.product_approval.enforce.v1
```

Behavior:
- Exit code `0`: no PAGE signal
- Exit code `2`: PAGE signal (rollback recommended)
- Exit code `1`: operational error (retry/investigate)

Automated guard with kill-switch activation:
```bash
cd frontend
npx tsx scripts/governance/authority-enforcement-auto-guard.ts \
  --mode local \
  --source cli_local \
  --tenantId <sandbox-tenant-id> \
  --policyId gov04.authority.catalog.product_approval.enforce.v1
```

Automated behavior:
- Persists guard report on every run.
- If guard status is `PAGE`, appends kill-switch activation control event.
- Exit code `2` on `PAGE`.

Scheduler wrapper (recommended command target):
```bash
cd frontend
scripts/governance/run-authority-enforcement-auto-guard.sh
```

Required wrapper environment:
- `GOV04_AUTH_GUARD_TENANT_ID`
- `GOV04_AUTH_GUARD_POLICY_ID`

Optional wrapper environment:
- `GOV04_AUTH_GUARD_MODE` (`local` or `http`)
- `GOV04_AUTH_GUARD_SOURCE` (`cli_local` or `cli_http`)
- `GOV04_AUTH_GUARD_URL` (required when mode is `http`)
- `GOV04_AUTH_GUARD_SECRET` (required when mode is `http` and secret not in env)
- `GOV04_AUTH_GUARD_LIMIT`
- `GOV04_AUTH_GUARD_TRIGGERED_BY`
- `GOV04_AUTH_GUARD_OUTPUT_DIR`

## Evidence and Audit Trail
Evidence sources:
- `governance_authority_shadow_decisions`
- `governance_authority_enforcement_decisions`
- `governance_authority_enforcement_guard_reports`
- `governance_authority_shadow_override_cases`
- `governance_authority_shadow_override_case_events`
- Shadow metrics report hash (`deterministicHashSha256`)

Required incident evidence when rollback occurs:
1. Guard output JSON for trigger window
2. Shadow metrics report hash
3. Enforcement decision IDs with divergence flag
4. Kill-switch toggle timestamp and operator

Optional persistence of guard reports:
```bash
cd frontend
npx tsx scripts/governance/authority-enforcement-guard.ts \
  --mode local \
  --source cli_local \
  --tenantId <sandbox-tenant-id> \
  --policyId gov04.authority.catalog.product_approval.enforce.v1 \
  --persist
```

## Progression Criteria
After 14 days of clean sandbox telemetry:
1. `deterministicMismatchTotal == 0` for all windows
2. `shadowVsEnforcementDivergenceRate <= 0.001` sustained
3. No uncontrolled case-open surge
4. No route-level regression in sandbox

Then evaluate strict mode pilot:
```env
GOV04_AUTH_ENFORCEMENT_STRICT_MODE=true
```
Only after governance sign-off.
