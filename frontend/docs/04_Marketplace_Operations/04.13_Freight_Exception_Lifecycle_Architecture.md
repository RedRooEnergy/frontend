# Freight Exception Lifecycle Architecture
Version: v1.0 (PROPOSED)  
Scope: Governance architecture; non-enforcing runtime

## Purpose
- Define the institutional exception model for freight governance.
- Convert passive freight audit signals into managed exception cases.
- Preserve current operating behavior (no escrow blocking, no freight mutation from exception engine).

## Guardrails (Mandatory)
- No operational enforcement in this phase.
- No escrow settlement blocking from exception state.
- No route decision changes based on exception outcomes.
- All exception and evidence records are append-only.
- Case status changes must be event-sourced (no silent in-place edits).

## Trigger Inputs
- Automated (from passive hooks and audit outcomes):
  - `BOOKED`
  - `DISPATCHED`
  - `CUSTOMS_CLEARED`
  - `DELIVERED`
  - `ESCROW_ELIGIBLE`
  - `PAYOUT_READY`
- Manual:
  - Freight operator raises exception.
  - Admin raises exception from oversight dashboard.

## Canonical Entities
1. `FreightExceptionCase`
- `exceptionId` (stable primary key)
- `tenantId`, `orderId`, `shipmentId`, `supplierId`, `freightPartnerId`
- `status` (`OPEN` | `IN_REVIEW` | `ACTION_REQUIRED` | `RESOLVED` | `CLOSED`)
- `severity` (`LOW` | `MEDIUM` | `HIGH` | `CRITICAL`)
- `origin` (`AUDIT_AUTOMATED` | `MANUAL_FREIGHT` | `MANUAL_ADMIN`)
- `openedAtUtc`, `openedByRole`, `openedById`
- `latestEventId`, `latestEventAtUtc`
- `linkedAuditRunId`, `linkedTriggerEvent`, `ruleSetVersion`

2. `FreightExceptionEvent` (append-only)
- `eventId` (immutable)
- `exceptionId`
- `eventType`:
  - `CASE_OPENED`
  - `STATUS_CHANGED`
  - `ASSIGNED`
  - `EVIDENCE_REQUESTED`
  - `EVIDENCE_ATTACHED`
  - `ADMIN_OVERRIDE_RECORDED`
  - `CASE_RESOLVED`
  - `CASE_CLOSED`
- `eventAtUtc`, `actorRole`, `actorId`
- `reasonCode`, `notes`
- `idempotencyKey`

3. `FreightExceptionEvidence` (append-only)
- `evidenceId`
- `exceptionId`, optional `eventId`
- `evidenceCode`
- `referenceType`, `referenceId`
- `contentHashSha256`
- `capturedAtUtc`, `capturedByRole`, `capturedById`
- `metadata`
- `idempotencyKey`

4. `FreightExceptionOverrideRecord` (append-only, non-enforcing in this phase)
- `overrideId`
- `exceptionId`
- `approvalId`
- `decisionType` (`ALLOW_PROGRESS` | `ALLOW_PAYOUT` | `MANUAL_CLOSE`)
- `rationale`
- `recordedAtUtc`
- `recordedByRole`, `recordedById`
- `evidenceManifestHash`

## Lifecycle State Machine
- `OPEN` -> `IN_REVIEW`
- `IN_REVIEW` -> `ACTION_REQUIRED`
- `ACTION_REQUIRED` -> `IN_REVIEW`
- `IN_REVIEW` -> `RESOLVED`
- `RESOLVED` -> `CLOSED`
- `OPEN` -> `CLOSED` only by admin with `approvalId` and rationale event

Invalid transitions must be rejected with explicit error codes.

## Case Creation Rules
- Create a case when:
  - Passive hook audit outcome is `FAILED`.
  - Passive hook audit outcome is `COMPLETED` and `summary.blockingFailures > 0`.
  - Manual exception submitted by freight/admin.
- Deduplicate by idempotency key:
  - `tenantId:orderId:shipmentId:triggerEvent:ruleSetVersion:errorOrFailureSignature`.

## Immutability and Integrity Controls
- Case header may update only through a linked `FreightExceptionEvent`.
- Events are append-only and time-ordered.
- Evidence is append-only, hash-validated (`SHA-256` hex).
- Override records are append-only and must include `approvalId`.
- No hard delete APIs.

## Observability and Monitoring
- Required metrics:
  - `exception_cases_opened_total`
  - `exception_cases_resolved_total`
  - `exception_cases_open_by_severity`
  - `exception_case_age_hours_p95`
  - `exception_hook_failures_total`
- Required logs:
  - case open/resolution/override events
  - hash validation failures
  - invalid transition attempts

## Tenant and Access Boundaries
- Every entity carries `tenantId`.
- Query paths must be tenant-scoped by default.
- Cross-tenant reads blocked unless regulator role with explicit scope policy.

## Non-Enforcement Contract
- Exception status does not block:
  - freight milestone updates
  - settlement initiation
  - payout completion
- Exception system is observational and review-driven until enforcement phase approval.

## Phase Sequencing
1. Phase 6A: Build exception persistence + event sourcing + admin review APIs (non-enforcing).
2. Phase 6B: Add dashboard visibility and resolution workflows.
3. Phase 7: Evaluate observed data; propose controlled enforcement gates under change control.

Status: Proposed.  
Implementation: Authorised for non-enforcing exception lifecycle only.
