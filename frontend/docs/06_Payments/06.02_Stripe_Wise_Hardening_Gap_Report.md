# Stripe + Wise Hardening Gap Report (Phase 0)
Version: v1.0 (PHASE 0 BASELINE)
Program: `EXT-PAYMENTS-03`
Date: 2026-02-12
Status: Baseline complete; implementation pending

## 1) Scope and Method
This report baselines the current Stripe and Wise implementation against enterprise payment hardening expectations and RRE platform standards.

Evidence sources are current repo paths only:
- Stripe API routes:
  - `frontend/app/api/payments/stripe/create-session/route.ts`
  - `frontend/app/api/payments/stripe/session/route.ts`
  - `frontend/app/api/payments/stripe/webhook/route.ts`
  - `frontend/app/api/payments/stripe/refund/route.ts`
  - `frontend/app/api/payments/stripe/state.ts`
- Wise payout route:
  - `frontend/app/api/settlements/wise/create-transfer/route.ts`
- Escrow/state interactions:
  - `frontend/lib/escrow.ts`
  - `frontend/app/checkout/page.tsx`
  - `frontend/lib/store.ts`
- Existing test coverage:
  - `frontend/tests/sandbox/runSandboxE2E.ts`
  - `frontend/tests/sandbox/README_SANDBOX_TESTS.md`
  - `frontend/tests/freight-customs/runFreightCustomsAudit.ts`

Governance alignment references (read-only / locked):
- `frontend/docs/06_Payments/06.01_Payments_and_Escrow_Hardening.md`
- `frontend/docs/99_Production/99.01_Production_Readiness_and_GoLive_Checklist.md`

## 2) Executive Summary
Current implementation is functional for sandbox flows but materially below industry-standard payment hardening for production money movement.

Primary systemic gap:
- Payment idempotency, webhook replay protection, and provider event truth are process-memory based or absent, not persistent.

Risk posture:
- Critical: duplicate payout/refund risk under concurrency/retries, replay resilience gaps, and client-side payment state finalization.
- High: missing provider lifecycle ledger/reconciliation and weak error taxonomy.
- Medium: observability and operational hardening gaps.

## 3) Risk Classification Table
| ID | Severity | Finding | Evidence (current path) | Resolved In Phase | Measurable Remediation Outcome | Rollback Impact Assessment |
|---|---|---|---|---|---|---|
| PAY-GAP-001 | Critical | Stripe webhook idempotency and session hash tracking are in-memory (`Set`/`Map`) and reset on process restart. | `frontend/app/api/payments/stripe/state.ts` | Phase 1 + Phase 2 | Duplicate Stripe events are deterministically ignored across restarts using persistent idempotency keys + unique indexes. | Low: feature flag back to legacy flow; no schema rollback required if additive collections are used. |
| PAY-GAP-002 | Critical | Stripe payment finalization is client-driven in checkout page, not server-side event ledger projection. | `frontend/app/checkout/page.tsx` (`markPaid` effect) | Phase 2 | Order payment transitions occur only from verified server webhook/session state; client cannot finalize financial state. | Medium: disable hardened flow flag; fallback to existing UI-driven behavior while preserving new ledger writes. |
| PAY-GAP-003 | Critical | Wise payout uses per-request random idempotency UUID, not deterministic order-scoped idempotency; duplicate admin retries can create duplicate transfer attempts. | `frontend/app/api/settlements/wise/create-transfer/route.ts` (`X-idempotence-uuid: crypto.randomUUID()`) | Phase 1 + Phase 3 | Deterministic `idempotencyKey` by tenant/order/attempt class with persistent dedupe guarantees one transfer intent per payout cycle. | Low: disable hardened Wise flow and use current path; hold/ledger tables remain append-only. |
| PAY-GAP-004 | Critical | No Wise webhook/callback verification surface exists; no provider event ingestion route for payout lifecycle truth. | Absence in `frontend/app/api/settlements/wise/*` (only `create-transfer`) | Phase 3 | Signed/token-verified Wise callback ingestion with replay-safe event ledger; or documented polling fallback with equivalent idempotency. | Medium: if callback path rolled back, payout state reverts to request/response-only and reconciliation gap reopens. |
| PAY-GAP-005 | Critical | Pricing snapshot integrity is weak: hash is non-cryptographic and client-generated; server accepts supplied hash without canonical recompute. | `frontend/app/checkout/page.tsx` (`computeSnapshotHash`), `frontend/app/api/payments/stripe/create-session/route.ts` | Phase 1 + Phase 2 | Server-side canonical snapshot hash (SHA-256) persisted before payment initiation; mismatch deterministically sets review state. | Medium: rollback to old hash path reintroduces tamper ambiguity. |
| PAY-GAP-006 | High | Settlement route mutates order to settlement-initiated before transfer success and without provider transfer ledger. | `frontend/app/api/settlements/wise/create-transfer/route.ts` (`markSettlementInitiated` before transfer call) | Phase 3 + Phase 4 | Separate immutable transfer intent/attempt records; order state updates tied to provider-confirmed progression. | Medium: rollback risks reintroducing partial settlement drift. |
| PAY-GAP-007 | High | Provider error mapping is coarse (`Stripe error`, `Wise transfer failed`), losing machine-actionable categories. | Stripe/Wise routes above | Phase 1 + Phase 2 + Phase 3 | Unified provider error taxonomy (`AUTH`, `VALIDATION`, `RATE_LIMIT`, `NETWORK`, `PROVIDER_5XX`, `IDEMPOTENCY_CONFLICT`) emitted in logs and responses. | Low: can retain generic outward error while preserving enriched internal mapping. |
| PAY-GAP-008 | High | Stripe refund marks local `REFUND_REQUESTED` before provider acceptance; failed provider calls can leave stale local intent without compensating state. | `frontend/app/api/payments/stripe/refund/route.ts` | Phase 2 | Two-stage refund intent/ack model with explicit failure compensation event and idempotent retry semantics. | Medium: rollback returns to current pre-ack mutation behavior. |
| PAY-GAP-009 | High | Environment separation is partial/test-centric (`*_TEST` vars, sandbox URLs hardcoded), with no formal runtime guardrail matrix. | Stripe routes + Wise route | Phase 1 | Startup/runtime validation enforces mutually exclusive env bundles (dev/stage/prod) and endpoint/key parity checks. | Low: runtime guard can be toggled in non-prod if migration blocked. |
| PAY-GAP-010 | High | No persistent provider event ledger (Stripe/Wise) for regulator replay and dispute forensics. | No payment ledger store under `frontend/lib/` | Phase 1 | Append-only `provider_event_ledger` + indexes by provider/eventId/orderId; deterministic replay exports possible. | Low: additive data model; rollback does not require deleting data. |
| PAY-GAP-011 | Medium | Stripe signature verifier does not enforce timestamp tolerance window; valid old signatures remain acceptable if event ID unseen. | `frontend/app/api/payments/stripe/webhook/route.ts` | Phase 2 | Timestamp skew policy (e.g. Â±300s) enforced before HMAC check acceptance. | Low: fallback to old verifier only impacts replay resilience. |
| PAY-GAP-012 | Medium | No payments-specific SLO metrics/alerts for provider latency, duplicate suppression rate, and webhook failure budget. | No dedicated payment metrics layer | Phase 4 | Metrics + alert thresholds defined and emitted for all money-movement and webhook critical paths. | Low: observability additions are non-invasive and additive. |
| PAY-GAP-013 | Medium | Current E2E focuses on happy/some negative paths; missing concurrency, provider outage, and partial settlement recovery matrix. | `frontend/tests/sandbox/runSandboxE2E.ts` | Phase 5 | Required matrix implemented with deterministic assertions for duplicate suppression, retries, and outage fallback. | Low: tests only; no runtime rollback needed. |
| PAY-GAP-014 | Medium | No explicit operations runbook for credential rotation, webhook replay response, and payment incident toggles. | Missing `frontend/docs/06_Payments/06.03_*` currently | Phase 4 + Phase 6 | Published runbook with rollback switches, incident criteria, and ownership matrix. | Low: documentation and toggle process only. |

## 4) Required Analysis Sections

### 4.1 Idempotency Implementation Analysis (Memory vs Persistent)
Current state:
- Stripe webhook dedupe is in-memory via `processedEvents: Set<string>` in `frontend/app/api/payments/stripe/state.ts`.
- Stripe session hash correlation is in-memory via `sessionHashes: Map<string,string>` in same file.
- Wise transfer idempotency uses per-request random UUID header in `frontend/app/api/settlements/wise/create-transfer/route.ts` and is not stored/reused per order.

Risk:
- Restart or horizontal scaling invalidates dedupe guarantees.
- Replay and duplicate financial mutations remain possible under real concurrency.

Target remediation:
- Persistent idempotency store and provider event ledger with unique indexes.

### 4.2 Webhook Verification Surface Review
Current state:
- Stripe webhook signature is verified by custom HMAC in `frontend/app/api/payments/stripe/webhook/route.ts`.
- Missing timestamp tolerance enforcement in signature acceptance path.
- Wise webhook surface is absent.

Risk:
- Stripe replay-window acceptance risk.
- Wise lifecycle has no authenticated callback path.

Target remediation:
- Harden Stripe verifier + timestamp policy.
- Add Wise callback route (or signed polling fallback) with idempotent event ingestion.

### 4.3 Money-Movement Concurrency Risks
Current state:
- Wise payout route can be triggered multiple times without deterministic order-scoped idempotency.
- Settlement progression writes can happen before final provider-confirmed transfer lifecycle is durably recorded.
- Refund request mutates order before Stripe refund acceptance.

Risk:
- Duplicate transfer attempts.
- State drift between order state and provider truth.

Target remediation:
- Deterministic transfer/refund intents + persistent idempotency locks + provider event reconciliation.

### 4.4 Provider Error Mapping Classification Gaps
Current state:
- Routes return generic `Stripe error` / `Wise transfer failed` patterns.
- No common internal error classifier for retryability and incident policy.

Risk:
- Ops cannot distinguish transient vs permanent failure classes.

Target remediation:
- Unified payment error taxonomy and structured logs with correlation IDs.

### 4.5 Escrow + Pricing Snapshot Interaction Mapping
Current flow:
- Checkout computes `pricingSnapshotHash` client-side using non-cryptographic function in `frontend/app/checkout/page.tsx`.
- Stripe session metadata carries this hash via `frontend/app/api/payments/stripe/create-session/route.ts`.
- Checkout page then fetches `/api/payments/stripe/session` and locally sets `PAID` or `PAYMENT_REVIEW_REQUIRED` based on hash compare.
- Escrow state transitions (`HELD`, `SETTLED`, `RELEASED`) are handled through `frontend/lib/escrow.ts` and payout/refund routes.

Gap:
- Critical payment-state transitions depend on client execution timing and local store mutation.

Target remediation:
- Server-authoritative transition model tied to verified provider events and immutable ledger records.

### 4.6 Current Test Coverage Delta vs Required Matrix
Current coverage present:
- Sandbox script covers session creation, webhook success, refund path, settlement path, and basic webhook idempotency (`frontend/tests/sandbox/runSandboxE2E.ts`).

Required but missing/insufficient:
- Deterministic concurrency tests for duplicate payout/refund requests.
- Provider outage/network timeout handling with retry classification assertions.
- Persistent replay tests across process restart semantics.
- Wise callback verification + replay tests.
- Reconciliation mismatch detection tests.

### 4.7 Production Failure Surface Analysis
Network failures:
- No centralized timeout/retry/circuit-break policy for Stripe/Wise provider calls.

Replay failures:
- Stripe replay dedupe memory-only; Wise replay model absent.

Provider outage:
- Generic error responses; no standardized retryability classification or incident hooks.

Partial settlement:
- Settlement initiation and payout processing can drift from provider-confirmed truth without a persistent transfer lifecycle ledger.

## 5) Phase Mapping and Acceptance Gates
Phase mapping for `EXT-PAYMENTS-03`:
- Phase 1: Core payment platform foundation (`config`, persistent idempotency, provider event ledger, env separation).
- Phase 2: Stripe hardening (server-authoritative transitions, webhook/replay hardening, refund sequencing).
- Phase 3: Wise hardening (deterministic payout idempotency, lifecycle ledger, callback/polling verification).
- Phase 4: Reconciliation + operations controls.
- Phase 5: Full test matrix closure.
- Phase 6: Flags and staged rollout controls.

## 6) Rollback Strategy Impact (Program-Level)
- Recommended rollout via additive schema + feature flags (`hardened stripe`, `hardened wise`, `reconciliation`).
- Rollback should disable hardened execution paths without deleting newly collected payment ledger/idempotency data.
- Highest rollback risk area: reverting server-authoritative payment state transitions once downstream logic depends on them; mitigate by dual-write/dual-read transition windows during rollout.

## 7) Phase 0 Exit Criteria
Phase 0 is complete when:
- All identified gaps are severity-ranked and phase-mapped.
- Each gap has measurable remediation outcomes.
- Rollback impacts are explicitly documented.

Phase 0 result: **Complete**.
