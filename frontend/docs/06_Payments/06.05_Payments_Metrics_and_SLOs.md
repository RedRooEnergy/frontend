# Payments Metrics and SLOs
Version: v1.0 (PHASE 5)
Program: `EXT-PAYMENTS-03`
Status: IMPLEMENTATION NOTE

## Scope and Boundary
- Metrics are additive instrumentation only.
- No settlement, escrow, or provider state mutation is allowed from metrics code.
- Internal snapshot route is signed and feature-flag gated.
- Authoritative metrics are ledger-derived from:
  - `payment_idempotency_keys`
  - `payment_provider_events`
  - `payment_wise_transfer_intents`
  - reconciliation engine output (Phase 4)
- Runtime counters are best-effort only and never authoritative.

## Feature Flags
- `ENABLE_PAYMENTS_METRICS` (default `false`)
- `ENABLE_PAYMENTS_METRICS_ROUTE` (default `false`)

## Internal Snapshot Route
- Endpoint: `POST /api/internal/payments/metrics/snapshot`
- Gate: both flags above must be `true`
- Secret: `PAYMENTS_METRICS_JOB_SECRET`
- Signature: `HMAC_SHA256(secret, "<timestamp>.<rawBody>")`
- Headers:
  - `x-rre-job-timestamp`
  - `x-rre-job-signature`
- Tolerance window: `Â±300s`

## CLI
- Script: `frontend/scripts/payments/metrics-snapshot.ts`
- Local mode:
  - `npx tsx scripts/payments/metrics-snapshot.ts --mode local --from 2026-02-13T00:00:00Z --to 2026-02-13T23:59:59Z --limit 1000`
- HTTP mode:
  - `npx tsx scripts/payments/metrics-snapshot.ts --mode http --url http://localhost:3000/api/internal/payments/metrics/snapshot --secret $PAYMENTS_METRICS_JOB_SECRET`

## Metric Taxonomy
### `payments_provider_api_latency_ms`
- Type: histogram/latency summary (`p50/p95/p99`, min, max, count)
- Unit: milliseconds
- Labels: `provider`, `endpointClass`, `scope`, `outcome`, `authoritative`
- Endpoint classes:
  - `stripe.checkout_session_create`
  - `stripe.refund_create`
  - `wise.transfer_create`
  - `wise.transfer_status_poll`

### `payments_webhook_verification_failures_total`
- Type: counter
- Unit: count
- Labels: `provider`, `route`, `failureCode`, `authoritative=false`

### `payments_webhook_duplicate_suppressed_total`
- Type: counter
- Unit: count
- Labels: `provider`, `route`, `eventType`, `authoritative=false`

### `payments_idempotency_conflicts_total`
- Type: counter
- Unit: count
- Labels: `provider`, `scope`, `conflictClass`, `authoritative=false`

### `payments_wise_intent_lifecycle_timing_ms`
- Type: histogram/latency summary (`p50/p95/p99`, min, max, count)
- Unit: milliseconds
- Labels: `provider=wise`, `endpointClass=wise.transfer_create`, `scope=WISE_TRANSFER_CREATE`, `outcome`
- Outcomes:
  - `INTENT_CREATED_TO_ACCEPTED:observed`
  - `ACCEPTED_TO_COMPLETED:observed`

### `payments_wise_polling_outcomes_total`
- Type: counter
- Unit: count
- Labels: `outcome`, `state`, `source`, `authoritative`
- Key outcome: `TERMINAL_EVENT_BACKED` indicates terminal mutation was event-backed.

### `payments_reconciliation_discrepancies_total`
- Type: counter
- Unit: count
- Labels: `code`, `severity`, `retryable`, `manualReviewRequired`, `authoritative=true`

### `payments_reconciliation_discrepancy_aging_total`
- Type: counter
- Unit: count
- Labels: `code`, `severity`, `ageBucket`, `authoritative=true`
- Age buckets: `0_15m`, `15_60m`, `1_6h`, `6_24h`, `gt_24h`

## SLO Definitions
### `SLO-STRIPE-CHECKOUT-LATENCY`
- Definition: p95 for `stripe.checkout_session_create`
- Window: rolling 1h
- Target: `<= 2000ms`
- Measurement: authoritative idempotency `createdAt -> updatedAt`
- Page when: `> 3000ms`

### `SLO-STRIPE-REFUND-LATENCY`
- Definition: p95 for `stripe.refund_create`
- Window: rolling 1h
- Target: `<= 3000ms`
- Measurement: authoritative idempotency `createdAt -> updatedAt`
- Page when: `> 5000ms`

### `SLO-WEBHOOK-VERIFY-FAIL-RATE`
- Definition: verification failures / (verification failures + provider events)
- Window: rolling 15m
- Target: `< 0.5%`
- Measurement: best-effort runtime counter in numerator + provider ledger denominator
- Page when: `> 2%`

### `SLO-WISE-ACCEPTANCE-LATENCY`
- Definition: p95 `INTENT_CREATED -> ACCEPTED`
- Window: rolling 24h
- Target: `<= 300000ms`
- Measurement: authoritative Wise intents + provider events
- Page when: `> 600000ms`

### `SLO-WISE-COMPLETION-LATENCY`
- Definition: p95 `ACCEPTED -> COMPLETED`
- Window: rolling 24h
- Target: `<= 3600000ms`
- Measurement: authoritative Wise intents + provider events
- Page when: `> 10800000ms`

### `SLO-WISE-TIMEOUT-RATE`
- Definition: timed-out intents / total intents
- Window: rolling 1h
- Target: `< 1%`
- Measurement: authoritative Wise intents
- Page when: `> 2%`

### `SLO-RECON-CRITICAL-DENSITY`
- Definition: critical discrepancies per 1000 scanned orders
- Window: per reconciliation run
- Target: `< 1`
- Measurement: authoritative reconciliation summary
- Page when: `> 5`

### `SLO-RECON-SETTLEMENT-CONTRADICTION`
- Definition: `SETTLEMENT_MARKED_NO_PROVIDER_COMPLETION` count
- Window: per reconciliation run
- Target: `0`
- Measurement: authoritative reconciliation summary
- Page when: `>= 1`

## Event/Log Schema
Structured log event names:
- `payments_metrics_provider_latency`
- `payments_metrics_webhook_verification_failed`
- `payments_metrics_webhook_duplicate_suppressed`
- `payments_metrics_idempotency_conflict`
- `payments_metrics_wise_polling_outcome`
- `payments_metrics_reconciliation_summary`

Common correlation fields (when available):
- `orderId`
- `provider`
- `eventId`
- `idempotencyKey`
- `stripePaymentIntentId`
- `wiseTransferId`
- `wiseIntentId`
- `deterministicHashSha256` (reconciliation or metrics report hash)

## Dashboards and Alerts
### Dashboard 1: Payments (Stripe)
Panels:
- Stripe checkout latency p50/p95/p99
- Stripe refund latency p50/p95/p99
- Webhook verification failure rate
- Webhook duplicate suppression count
- Idempotency conflicts by scope/class

Alerts:
- Stripe checkout p95 `> 3000ms` for 10m
- Stripe refund p95 `> 5000ms` for 10m
- Webhook verify fail rate `> 2%` for 5m

### Dashboard 2: Settlements (Wise)
Panels:
- Wise create latency p50/p95/p99
- Wise acceptance latency and completion latency
- Polling outcomes (`TERMINAL_EVENT_BACKED`, `TIMEOUT`, `NO_TERMINAL_EVENT`)
- Timeout rate

Alerts:
- Wise acceptance p95 `> 600000ms` for 30m
- Wise completion p95 `> 10800000ms` for 30m
- Timeout rate `> 2%` for 15m

### Dashboard 3: Reconciliation/Health
Panels:
- Discrepancy counts by code/severity
- Discrepancy aging buckets by code
- Critical density per run
- Settlement contradiction count

Alerts:
- Any run with `SETTLEMENT_MARKED_NO_PROVIDER_COMPLETION >= 1`
- Critical density `> 5/1000`

Escalation target:
- Primary: Payments Ops on-call
- Secondary: Platform Reliability / Governance duty owner

## Governance Boundary
Metrics snapshot and instrumentation are read-only.
Forbidden actions:
- No `writeStore(...)` from metrics engine/route
- No escrow/refund helpers in metrics path
- No provider create/refund/transfer calls from metrics path
