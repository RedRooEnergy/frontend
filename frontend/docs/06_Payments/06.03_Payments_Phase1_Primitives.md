# Payments Phase 1 Primitives
Version: v1.0 (IMPLEMENTATION NOTE)
Program: `EXT-PAYMENTS-03`
Status: Phase 1 foundation primitives added

## Scope
This note documents the additive primitives introduced in Phase 1. No locked governance document was modified.

Implemented modules:
- `frontend/lib/payments/config.ts`
- `frontend/lib/payments/types.ts`
- `frontend/lib/payments/logging.ts`
- `frontend/lib/payments/idempotencyStore.ts`
- `frontend/lib/payments/providerEventStore.ts`

## Index Definitions
### `payment_idempotency_keys`
- Unique: `{ provider: 1, scope: 1, key: 1 }`
- Operational: `{ status: 1, updatedAt: -1 }`
- Query support: `{ orderId: 1, createdAt: -1 }`
- TTL (optional use): `{ expiresAt: 1 }` with `expireAfterSeconds: 0`

### `payment_provider_events`
- Unique: `{ provider: 1, eventId: 1 }`
- Query support: `{ orderId: 1, createdAt: -1 }`
- Operational: `{ provider: 1, receivedAt: -1 }`

## Deterministic Idempotency Key Semantics
`buildPaymentIdempotencyKey()` serializes ordered key parts as `<length>:<value>` segments joined by `|`.

Example format:
- `2:v1|5:stripe|...`

This avoids boundary collisions and ensures deterministic behavior for lock acquisition and replay suppression.

`buildScopedPaymentIdempotencyKey()` enforces fixed part order:
1. version
2. provider
3. scope
4. tenantId
5. orderId
6. operation
7. referenceId
8. attemptClass

## Runtime Environment Validation
`validatePaymentsRuntimeConfig()` hard-fails on mismatched bundles, including:
- test credentials present in production
- missing webhook secret when hardened Stripe flow is enabled
- missing Wise profile when hardened Wise flow is enabled

Phase 1 keeps hardened flow flags default-off and does not enable hardened route behavior by default.
