# Payments Reconciliation Runbook
Version: v1.0 (PHASE 4)
Program: `EXT-PAYMENTS-03`
Status: IMPLEMENTATION NOTE

## Scope
This runbook documents operational controls for Phase 4 reconciliation.
It is read-only by design and does not execute payment, escrow, or settlement mutations.

## Reconciliation Invocation
### Internal route
- Endpoint: `POST /api/internal/payments/reconcile`
- Gate: `ENABLE_PAYMENTS_RECONCILIATION=true`
- Auth headers:
  - `x-rre-job-timestamp`
  - `x-rre-job-signature`
- Signature format:
  - `HMAC_SHA256(PAYMENTS_RECONCILIATION_JOB_SECRET, "<timestamp>.<rawBody>")`
- Timestamp tolerance: `Â±300s`

### CLI
- Script: `frontend/scripts/payments/reconcile.ts`
- Local mode example:
  - `npx tsx scripts/payments/reconcile.ts --mode local --from 2026-02-13T00:00:00Z --to 2026-02-13T23:59:59Z --limit 500`
- HTTP mode example:
  - `npx tsx scripts/payments/reconcile.ts --mode http --url http://localhost:3000/api/internal/payments/reconcile --secret $PAYMENTS_RECONCILIATION_JOB_SECRET`

## Discrepancy Classes
- `PAYMENT_CONFIRMED_NO_ESCROW`
- `ESCROW_HELD_NO_PROVIDER_CONFIRMATION`
- `TRANSFER_COMPLETED_NO_SETTLEMENT`
- `SETTLEMENT_MARKED_NO_PROVIDER_COMPLETION`
- `IDENTITY_MISMATCH`

## Severity and Action Rules
- `WARNING`: monitor and retry reconciliation after provider/event propagation window.
- `CRITICAL`: immediate manual review required; no auto-remediation.
- Retryable classes:
  - `PAYMENT_CONFIRMED_NO_ESCROW`
  - `ESCROW_HELD_NO_PROVIDER_CONFIRMATION`
  - `TRANSFER_COMPLETED_NO_SETTLEMENT`
- Manual-review classes:
  - `SETTLEMENT_MARKED_NO_PROVIDER_COMPLETION`
  - `IDENTITY_MISMATCH`

## Credential Rotation
### Rotation inventory
- `STRIPE_SECRET_KEY_*`
- `STRIPE_WEBHOOK_SECRET_*`
- `WISE_*API_KEY*`
- `WISE_WEBHOOK_*`
- `PAYMENTS_RECONCILIATION_JOB_SECRET`

### Procedure
1. Generate new secret/key in provider console or secrets manager.
2. Deploy with dual validity window where supported.
3. Verify route signatures/webhooks in sandbox and production telemetry.
4. Revoke old key after successful verification window.
5. Run reconciliation to confirm no signature-related discrepancy spike.

## Webhook Replay Procedure
1. Identify time window and affected provider event IDs.
2. Replay provider events via provider tooling (Stripe dashboard / Wise callback replay or polling job).
3. Confirm event ledger records are appended idempotently (`provider + eventId` uniqueness).
4. Re-run reconciliation with bounded `fromUtc`/`toUtc` filters.
5. Escalate remaining `CRITICAL` discrepancies to manual review queue.

## Timeout Recovery (Wise)
1. Identify intents with `state=TIMED_OUT` and `autoRetryBlocked=true`.
2. Perform operator review of provider status and transfer evidence.
3. Record approved override through admin process.
4. Trigger controlled retry (new release attempt only).
5. Re-run reconciliation and confirm discrepancy clearance.

## Manual Override Procedure
1. Validate discrepancy evidence (provider event ledger + order timeline + intent state).
2. Obtain `approvalId`, rationale, and evidence manifest hash.
3. Record override in governance subsystem before financial action.
4. Execute bounded corrective action.
5. Reconcile again and attach report hash to incident/case.

## Incident Triage Matrix
| Condition | Severity | Owner | Immediate Action |
|---|---|---|---|
| `SETTLEMENT_MARKED_NO_PROVIDER_COMPLETION` | CRITICAL | Payments + Governance | Freeze affected payout retries, open manual case |
| `IDENTITY_MISMATCH` | CRITICAL | Payments + Security | Lock order for review, investigate snapshot integrity |
| `TRANSFER_COMPLETED_NO_SETTLEMENT` (aged) | CRITICAL | Payments Ops | Manual settlement verification and correction path |
| `ESCROW_HELD_NO_PROVIDER_CONFIRMATION` (aged) | CRITICAL | Payments Ops | Verify provider truth and escrow timeline |
| transient WARNING discrepancies | WARNING | Payments Ops | Re-run reconciliation after propagation delay |

## Governance Boundary
Reconciliation outputs reports only.
Forbidden actions:
- No `writeStore(...)` mutations.
- No `markSettled(...)`, `markRefunded(...)`, or settlement/refund side effects.
- No provider transfer/refund/session creation.
